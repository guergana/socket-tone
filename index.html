
<!doctype html>
<html>
  <head>
    <title>Interative Socket Music</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 80%; margin-right: .5%; }
      form button { width: 16%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
	  .username { color: #f00; }
    </style>
  </head>
  <body>
  <div id="Keyboard" style="width:600px;"></div>
  <div class="float:left;clear:both;"></div>
  <div style="float:left;width:100px;border-right:1px solid black;padding:10px;overflow:scroll-y;">
	<b>USERS</b>
	<div id="users"></div>
	
</div>

  <div style="float:left;width:500px;overflow-y:scroll-y;padding:10px;">
	
    <ul id="messages"></ul>
    <!--<form action="">
      <input id="m" autocomplete="off" /><button>Send</button>
    </form> -->
</div>
<script src="/socket.io/socket.io.js"></script>
<script type="text/javascript" src="scripts/Tone.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<script>

  var socket = io();	
			
	//Load loop
	var audioElement = document.createElement('audio');
	audioElement.setAttribute('src', 'audio/paniloop.mp3');
	

  socket.on('connect', function(){
		// call the server-side function 'adduser' and send one parameter (value of prompt)
		
		var name = prompt("What's your name?");
		audioElement.load();
		socket.emit('adduser', name);
		
	});

	socket.on('isfirstuser', function(isfirstuser){
		
		if(isfirstuser == true){
				$('#messages').append('<button onclick="playloop()" type="button">Start loop</button><br/>');
				

				audioElement.addEventListener('ended', function() {
					this.currentTime = 0;
					this.play();
				}, false);
			
		} 
		if(audioElement.currentTime != 0){
			socket.emit('time', audioElement.currentTime);
		}
		
	});
	
	socket.on('play', function(time){
			audioElement.currentTime = time;
			console.log(time);
		audioElement.oncanplaythrough = function() {
					
					audioElement.play();
			};
		audioElement.addEventListener('ended', function() {
					this.currentTime = 0;
					this.play();
				}, false);
	
	});
	
	function playloop(){
		
		//audioElement.oncanplaythrough = function() {
					audioElement.play();
			//};
	}
	
  
  // listener, whenever the server emits 'updatechat', this updates the chat body
	socket.on('updatechat', function (username, data) {
	
		if(data.type === 'keyDown'){
			synth.triggerAttack(data.note);
			$('#messages').append('<b class="username">'+username + ':</b> Pressed key: '+ data.keyboard +' Midi Code: '+ data.MIDI +' Note: ' + data.note + '<br>');
		} else if(data.type === 'keyUp'){
			synth.triggerRelease();
		} else {
		
			// if it's not a note. if it's a SERVER message, as when someone connects
			$('#messages').append('<b class="username">'+username + ':</b> ' + data + '<br>');
		}
		
		
	} );
	
	
	// listener, whenever the server emits 'updateusers', this updates the username list
	socket.on('updateusers', function(data) {
		$('#users').empty();
		$.each(data, function(key, value) {
			$('#users').append('<div>' + key + '</div>');
		});
		
	});
	
	

</script>
	<script type="text/javascript">
	
	function keyToNote_func(pressed_key){
			var noteNames = ["C", "C#/Db", "D", "D#/Eb", "E", "F", "F#/Gb", "G", "G#/Ab", "A", "A#/Bb", "B"];
			
				var pitchClass = noteNames[pressed_key % 12];
                var octave     = (pressed_key - 12) / 12 >> 0;
                var noteName   = pitchClass + octave;

                return noteName;
                
		}
		
		$.getJSON('scripts/keymap.json', function(data) {
  
			for (var i = 0; i < data.length; i++) {
				$.each(data[i], function(j, object) {
					//console.log(object.keyCap + "MIDI " + object.keyCode);
					
					 $( document ).keypress(function( event ) {
						
						var realKey = String.fromCharCode(event.which);
						
						if (object.keyCap == realKey) {
							//$("#messages").append("keyboard: " + object.keyCap + " MIDI: " + object.keyCode + " Note: " + keyToNote_func(object.keyCode) + "<br/>" );
							//alert("note:" + keyToNote_func(object.keyCode));
							
							//if it's a double note make it a simple note
							
							var note = keyToNote_func(object.keyCode);
							
							if( note.indexOf( "/" ) != -1 ){
								note =  note.substring( 0, note.indexOf( "/" ) );
							}
							
							
							var data = {
								note: note,
								MIDI : object.keyCode,
								keyboard: object.keyCap,
								type: 'keyDown'
							};
							socket.emit('sendchat', data);
							return;
						}
					});
					
					 $( document ).keyup(function( ) {
							
						var data = {
							type: 'keyUp'
						};
						socket.emit('sendchat', data);
						
						
					});
				});
			}
         
		
  });

		var synth = new Tone.Synth({
			"oscillator" : {
				"type" : "square"
			},
			"envelope" : {
				"attack" : 0.01,
				"decay" : 0.2,
				"sustain" : 0.2,
				"release" : 0.2,
			}
		}).toMaster();

	</script>

	
  </body>
</html>